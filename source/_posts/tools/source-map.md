---
title: tools 之 source-map
categories:
- tools
---
一个最简单的优化网站方法就是合并、压缩 JS 和 CSS 文件。但是如果需要在这些压缩后的文件中进行调试，这个时候实际运行的代码不同于开发代码，debug 会变得很困难，这就是 Source Map 想要解决的问题。
<!--more-->
### 一、什么是 Source Map
Source Map 提供了一个映射压缩文件到原文件初始位置的方法。这就意味着，使用浏览器或者其他软件可以轻松调试文件，即使是在资源文件以及被压缩后。Chrome 和 Firefox 开发工具都已经内置支持 Source Map 了。当代码出错的时候，调试工具将直接显示原文件代码，而不是压缩后的，给开发者带来了很大方便。
<img src="/assets/tools/chrome-tools.png">
<img src="/assets/tools/firefox-tools.png">
### 二、Source Map 如何生效
只要在转换后的代码尾部，加上一行就可以启用 Source Map 了，map 文件可以放在网络上，也可以放在本地文件系统。
```
//@ sourceMappingURL=/path/to/file.js.map
```
可以使用 UglifyJS 等工具生成 Source Map。
### 三、Source Map 原理
##### 3.1 打开 Source map 文件，它大概是这个样子：
```
{
　 version : 3,
 　file: "out.js",
 　sourceRoot : "",
 　sources: ["foo.js", "bar.js"],
 　names: ["src", "maps", "are", "fun"],
 　mappings: "AAgBC,SAAQ,CAAEA"
}
```
##### 3.2 整个文件就是一个 JavaScript 对象，可以被解释器读取。它主要有以下几个属性：
```
- version：Source map 的版本规范，目前为3。
  
- file：转换后的文件名。
  
- sourceRoot：转换前的文件所在的目录。如果与转换前的文件在同一目录，该项为空。
  
- sources：转换前的文件。该项是一个数组，表示可能存在多个文件合并。
  
- names：转换前的所有变量名和属性名。
  
- mappings：记录位置信息的字符串。
```
##### 3.3 两个文件的各个位置一一对应的关键就是 map 文件的 mappings 属性。这是一个很长的字符串，它分成三层。
```
第一层是行对应，以分号（;）表示，每个分号对应转换后源码的一行。所以，第一个分号前的内容，就对应源码的第一行，以此类推。
  
第二层是位置对应，以逗号（,）表示，每个逗号对应转换后源码的一个位置。所以，第一个逗号前的内容，就对应该行源码的第一个位置，以此类推。
  
第三层是位置转换，以 VLQ 编码表示，代表该位置对应的转换前的源码位置。
```
##### 3.4 举例来说，假定 mappings 属性的内容如下：
```
// 表示转换后的源码分成两行，第一行有两个位置，第二行有一个位
mappings:"AAAAA,BBBBB;CCCCC"
```
##### 3.5 每个位置使用五位，表示五个字段。从左边算起：
```
- 第一位，表示这个位置在（转换后的代码的）的第几列。
  
- 第二位，表示这个位置属于 sources 属性中的哪一个文件。
  
- 第三位，表示这个位置属于转换前代码的第几行。
  
- 第四位，表示这个位置属于转换前代码的第几列。
  
- 第五位，表示这个位置属于names属性中的哪一个变量。
```
有几点需要说明。首先，所有的值都是以 0 作为基数的。其次，第五位不是必需的，如果该位置没有对应 names 属性中的变量，可以省略第五位。再次，每一位都采用 VLQ 编码表示；由于 VLQ 编码是变长的，所以每一位可以由多个字符构成。如果某个位置是 AAAAA，由于 A 在 VLQ 编码中表示 0，因此这个位置的五个位实际上都是 0。它的意思是，该位置在转换后代码的第 0 列，对应 sources 属性中第 0 个文件，属于转换前代码的第 0 行第 0 列，对应 names 属性中的第 0 个变量。