<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>node 之 event-loop | 青松的博客 | 天行健，君子以自强不息；地势坤，君子以厚德载物。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器更复杂，因为它可以跟内核对话，不得不搞了一个专门的库 libuv 做这件事。这个库负责各种回调函数的执行时间，毕竟异步任务最后还是要回到主线程，一个个排队执行，这就是事件循环。">
<meta name="keywords" content="分享、总结">
<meta property="og:type" content="article">
<meta property="og:title" content="node 之 event-loop">
<meta property="og:url" content="http://blog.master-ss.cn/node/event-loop/index.html">
<meta property="og:site_name" content="青松的博客">
<meta property="og:description" content="我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器更复杂，因为它可以跟内核对话，不得不搞了一个专门的库 libuv 做这件事。这个库负责各种回调函数的执行时间，毕竟异步任务最后还是要回到主线程，一个个排队执行，这就是事件循环。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://blog.master-ss.cn/assets/node/event-loop.jpg">
<meta property="og:updated_time" content="2018-04-19T08:47:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="node 之 event-loop">
<meta name="twitter:description" content="我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器更复杂，因为它可以跟内核对话，不得不搞了一个专门的库 libuv 做这件事。这个库负责各种回调函数的执行时间，毕竟异步任务最后还是要回到主线程，一个个排队执行，这就是事件循环。">
<meta name="twitter:image" content="http://blog.master-ss.cn/assets/node/event-loop.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="青松的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.png)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">张松松</h5>
          <a href="mailto:1733458402@qq.com" title="1733458402@qq.com" class="mail">1733458402@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/node">
                <i class="icon icon-lg icon-bandcamp"></i>
                Node
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/source">
                <i class="icon icon-lg icon-anchor"></i>
                Source
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zss007" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">node 之 event-loop</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">node 之 event-loop</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-03-25T10:36:10.000Z" itemprop="datePublished" class="page-time">
  2018-03-25
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/node/">node</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一、定时器"><span class="post-toc-text">一、定时器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#二、同步任务和异步任务"><span class="post-toc-text">二、同步任务和异步任务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#三、本轮循环和次轮循环"><span class="post-toc-text">三、本轮循环和次轮循环</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#四、process-nextTick"><span class="post-toc-text">四、process.nextTick()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#五、微任务"><span class="post-toc-text">五、微任务</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#六、事件循环执行顺序"><span class="post-toc-text">六、事件循环执行顺序</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#七、事件循环示例"><span class="post-toc-text">七、事件循环示例</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#八、setTimeout-和-setImmediate"><span class="post-toc-text">八、setTimeout 和 setImmediate</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#九、综合实例"><span class="post-toc-text">九、综合实例</span></a></li></ol>
        </nav>
    </aside>


<article id="post-node/event-loop" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">node 之 event-loop</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-03-25 18:36:10" datetime="2018-03-25T10:36:10.000Z" itemprop="datePublished">2018-03-25</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/node/">node</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器更复杂，因为它可以跟内核对话，不得不搞了一个专门的库 libuv 做这件事。这个库负责各种回调函数的执行时间，毕竟异步任务最后还是要回到主线程，一个个排队执行，这就是事件循环。<br><a id="more"></a></p>
<h3 id="一、定时器"><a href="#一、定时器" class="headerlink" title="一、定时器"></a>一、定时器</h3><p>为了协调异步任务，Node 提供了四个定时器，让任务可以在指定的时间运行：setTimeout、setInterval、setImmediate、process.nextTick。前两个是语言的标准，后两个是 Node 独有的。它们的写法差不多，作用也差不多，不太容易区别。举个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// test.js</span><br><span class="line">setTimeout(() =&gt; console.log(1));</span><br><span class="line">setImmediate(() =&gt; console.log(2));</span><br><span class="line">process.nextTick(() =&gt; console.log(3));</span><br><span class="line">Promise.resolve().then(() =&gt; console.log(4));</span><br><span class="line">(() =&gt; console.log(5))();</span><br><span class="line">  </span><br><span class="line">$ node test.js</span><br><span class="line">5</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure></p>
<h3 id="二、同步任务和异步任务"><a href="#二、同步任务和异步任务" class="headerlink" title="二、同步任务和异步任务"></a>二、同步任务和异步任务</h3><p>首先，同步任务总是比异步任务更早执行。前面的那段代码，只有最后一行是同步任务，因此最早执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(() =&gt; console.log(5))();</span><br></pre></td></tr></table></figure></p>
<h3 id="三、本轮循环和次轮循环"><a href="#三、本轮循环和次轮循环" class="headerlink" title="三、本轮循环和次轮循环"></a>三、本轮循环和次轮循环</h3><p>异步任务可以分成两种：追加在本轮循环的异步任务、追加在次轮循环的异步任务。所谓 “循环”，指的是事件循环（event loop）。这是 JavaScript 引擎处理异步任务的方式，本轮循环一定早于次轮循环执行即可。Node 规定，process.nextTick 和 Promise 的回调函数，追加在本轮循环，即同步任务一旦执行完成，就开始执行它们。而 setTimeout、setInterval、setImmediate 的回调函数，追加在次轮循环。这就是说，上段代码的第三行和第四行，一定比第一行和第二行更早执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 下面两行，次轮循环执行</span><br><span class="line">setTimeout(() =&gt; console.log(1));</span><br><span class="line">setImmediate(() =&gt; console.log(2));</span><br><span class="line">// 下面两行，本轮循环执行</span><br><span class="line">process.nextTick(() =&gt; console.log(3));</span><br><span class="line">Promise.resolve().then(() =&gt; console.log(4));</span><br></pre></td></tr></table></figure></p>
<h3 id="四、process-nextTick"><a href="#四、process-nextTick" class="headerlink" title="四、process.nextTick()"></a>四、process.nextTick()</h3><p>process.nextTick 这个名字有点误导，它是在本轮循环执行的，而且是所有异步任务里面最快执行的。Node 执行完所有同步任务，接下来就会执行 process.nextTick 的任务队列。所以，下面这行代码是第二个输出结果。基本上，如果你希望异步任务尽可能快地执行，那就使用process.nextTick。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process.nextTick(() =&gt; console.log(3));</span><br></pre></td></tr></table></figure></p>
<h3 id="五、微任务"><a href="#五、微任务" class="headerlink" title="五、微任务"></a>五、微任务</h3><p>根据语言规定，Promise 对象的回调函数，会进入异步任务里面的”微任务”（microtask）队列。微任务队列追加在 process.nextTick 队列的后面，也属于本轮循环。所以，下面的代码总是先输出 3，再输出 4。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">process.nextTick(() =&gt; console.log(3));</span><br><span class="line">Promise.resolve().then(() =&gt; console.log(4));</span><br><span class="line">// 3</span><br><span class="line">// 4</span><br><span class="line">  </span><br><span class="line">// 注意，只有前一个队列全部清空以后，才会执行下一个队列。代码中，全部 process.nextTick 的回调函数，执行都会早于 Promise</span><br><span class="line">process.nextTick(() =&gt; console.log(1));</span><br><span class="line">Promise.resolve().then(() =&gt; console.log(2));</span><br><span class="line">process.nextTick(() =&gt; console.log(3));</span><br><span class="line">Promise.resolve().then(() =&gt; console.log(4));</span><br><span class="line">// 1</span><br><span class="line">// 3</span><br><span class="line">// 2</span><br><span class="line">// 4</span><br></pre></td></tr></table></figure></p>
<p>至此，本轮循环的执行顺序就讲完了：同步任务 =&gt; process.nextTick() =&gt; 微任务</p>
<h3 id="六、事件循环执行顺序"><a href="#六、事件循环执行顺序" class="headerlink" title="六、事件循环执行顺序"></a>六、事件循环执行顺序</h3><p>Node 只有一个主线程，事件循环是在主线程上完成的。开始执行脚本时，会先进行事件循环的初始化，但是这时事件循环还没有开始，会先完成下面的事情：同步任务、发出异步请求、规划定时器生效的时间、执行 process.nextTick() 等等。最后，上面这些事情都干完了，事件循环就正式开始了。事件循环会无限次地执行，一轮又一轮。只有异步任务的回调函数队列清空了，才会停止执行。每一轮的事件循环，分成六个阶段，这些阶段会依次执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、timers</span><br><span class="line">2、I/O callbacks</span><br><span class="line">3、idle, prepare</span><br><span class="line">4、poll</span><br><span class="line">5、check</span><br><span class="line">6、close callbacks</span><br></pre></td></tr></table></figure></p>
<p>每个阶段都有一个先进先出的回调函数队列。只有一个阶段的回调函数队列清空了，该执行的回调函数都执行了，事件循环才会进入下一个阶段。简单介绍一下每个阶段的含义：<br>（1）timers：这个是定时器阶段，处理 setTimeout() 和 setInterval() 的回调函数。进入这个阶段后，主线程会检查一下当前时间，是否满足定时器的条件。如果满足就执行回调函数，否则就离开这个阶段。<br>（2）I/O callbacks：除了举出的这些操作回调函数，其他的回调函数都在这个阶段执行：setTimeout() 和 setInterval() 的回调函数、<br>setImmediate() 的回调函数、用于关闭请求的回调函数，比如 socket.on(‘close’, …)。<br>（3）idle, prepare：该阶段只供 libuv 内部调用，这里可以忽略。<br>（4）Poll：这个阶段是轮询时间，用于等待还未返回的 I/O 事件，比如服务器的回应、用户移动鼠标等等。这个阶段的时间会比较长。如果没有其他异步任务要处理（比如到期的定时器），会一直停留在这个阶段，等待 I/O 请求返回结果。<br>（5）check：该阶段执行 setImmediate() 的回调函数。<br>（6）close callbacks：该阶段执行关闭请求的回调函数，比如 socket.on(‘close’, …)。</p>
<h3 id="七、事件循环示例"><a href="#七、事件循环示例" class="headerlink" title="七、事件循环示例"></a>七、事件循环示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line"></span><br><span class="line">const timeoutScheduled = Date.now();</span><br><span class="line"></span><br><span class="line">// 异步任务一：100ms 后执行的定时器</span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  const delay = Date.now() - timeoutScheduled;</span><br><span class="line">  console.log(`$&#123;delay&#125;ms`);</span><br><span class="line">&#125;, 100);</span><br><span class="line"></span><br><span class="line">// 异步任务二：文件读取后，有一个 200ms 的回调函数</span><br><span class="line">fs.readFile(&apos;test.js&apos;, () =&gt; &#123;</span><br><span class="line">  const startCallback = Date.now();</span><br><span class="line">  while (Date.now() - startCallback &lt; 200) &#123;</span><br><span class="line">    // 什么也不做</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面代码有两个异步任务，一个是 100ms 后执行的定时器，一个是文件读取，它的回调函数需要 200ms。请问运行结果是什么？<br><img src="/assets/node/event-loop.jpg"><br>脚本进入第一轮事件循环以后，没有到期的定时器，也没有已经可以执行的 I/O 回调函数，所以会进入 Poll 阶段，等待内核返回文件读取的结果。由于读取小文件一般不会超过 100ms，所以在定时器到期之前，Poll 阶段就会得到结果，因此就会继续往下执行。第二轮事件循环，依然没有到期的定时器，但是已经有了可以执行的 I/O 回调函数，所以会进入 I/O callbacks 阶段，执行 fs.readFile 的回调函数。这个回调函数需要 200ms，也就是说，在它执行到一半的时候，100ms 的定时器就会到期。但是，必须等到这个回调函数执行完，才会离开这个阶段。第三轮事件循环，已经有了到期的定时器，所以会在 timers 阶段执行定时器。最后输出结果大概是 200 多毫秒。</p>
<h3 id="八、setTimeout-和-setImmediate"><a href="#八、setTimeout-和-setImmediate" class="headerlink" title="八、setTimeout 和 setImmediate"></a>八、setTimeout 和 setImmediate</h3><p>由于 setTimeout 在 timers 阶段执行，而 setImmediate 在 check 阶段执行。所以，setTimeout 会早于 setImmediate 完成。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() =&gt; console.log(1));</span><br><span class="line">setImmediate(() =&gt; console.log(2));</span><br></pre></td></tr></table></figure></p>
<p>上面代码应该先输出 1，再输出 2，但是实际执行的时候，结果却是不确定，有时还会先输出 2，再输出 1。这是因为 setTimeout 的第二个参数默认为 0。但是实际上，Node 做不到 0 毫秒，最少也需要 1 毫秒，根据官方文档，第二个参数的取值范围在 1 毫秒到 2147483647 毫秒之间。也就是说，setTimeout(f, 0) 等同于setTimeout(f, 1)。实际执行的时候，进入事件循环以后，有可能到了 1 毫秒，也可能还没到 1 毫秒，取决于系统当时的状况。如果没到 1 毫秒，那么 timers 阶段就会跳过，进入 check 阶段，先执行 setImmediate 的回调函数。但是，下面的代码一定是先输出 2，再输出 1。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line"></span><br><span class="line">fs.readFile(&apos;test.js&apos;, () =&gt; &#123;</span><br><span class="line">  setTimeout(() =&gt; console.log(1));</span><br><span class="line">  setImmediate(() =&gt; console.log(2));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面代码会先进入 I/O callbacks 阶段，然后是 check 阶段，最后才是 timers 阶段。因此，setImmediate 才会早于 setTimeout 执行。</p>
<h3 id="九、综合实例"><a href="#九、综合实例" class="headerlink" title="九、综合实例"></a>九、综合实例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">const &#123; readFile, readFileSync &#125; = require(&apos;fs&apos;)</span><br><span class="line">const &#123; resolve &#125; = require(&apos;path&apos;)</span><br><span class="line"></span><br><span class="line">setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] immediate 回调1&apos;))</span><br><span class="line">setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] immediate 回调2&apos;))</span><br><span class="line">setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] immediate 回调3&apos;))</span><br><span class="line"></span><br><span class="line">Promise.resolve().then(() =&gt; &#123;</span><br><span class="line">    console.log(&apos;[...待切入下一阶段] promise 回调1&apos;)</span><br><span class="line"></span><br><span class="line">    setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] promise 回调1 增加的immediate 回调4&apos;))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">readFile(&apos;../package.json&apos;, &apos;utf-8&apos;, data =&gt; &#123;</span><br><span class="line">    console.log(&apos;[阶段2....IO回调] 读文件回调1&apos;)</span><br><span class="line"></span><br><span class="line">    readFile(&apos;../video.mp4&apos;, &apos;utf-8&apos;, data =&gt; &#123;</span><br><span class="line">        console.log(&apos;[阶段2....IO回调] 读文件回调2&apos;)</span><br><span class="line"></span><br><span class="line">        setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] 读文件回调2 增加的immediate 回调4&apos;))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    setImmediate(() =&gt; &#123;</span><br><span class="line">        console.log(&apos;[阶段3.immediate] immediate 回调4&apos;)</span><br><span class="line"></span><br><span class="line">        Promise.resolve().then(() =&gt; &#123;</span><br><span class="line">            console.log(&apos;[...待切入下一阶段] promise 回调2&apos;)</span><br><span class="line">            process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] promise 回调2 增加的 nextTick 回调5&apos;))</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">            console.log(&apos;[...待切入下一阶段] promise 回调3&apos;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    setImmediate(() =&gt; &#123;</span><br><span class="line">        console.log(&apos;[阶段3.immediate] immediate 回调6&apos;)</span><br><span class="line"></span><br><span class="line">        process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] immediate 回调6 增加的 nextTick 回调7&apos;))</span><br><span class="line">        console.log(&apos;[...待切入下一阶段] 这块正在同步阻塞的读一个大文件&apos;);</span><br><span class="line">        const video = readFileSync(resolve(__dirname, &apos;../video.mp4&apos;), &apos;utf-8&apos;)</span><br><span class="line">        process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] immediate 回调6 增加的 nextTick 回调8&apos;))</span><br><span class="line"></span><br><span class="line">        readFile(&apos;../package.json&apos;, &apos;utf-8&apos;, () =&gt; &#123;</span><br><span class="line">            console.log(&apos;[阶段2....IO回调] 读文件回调3&apos;)</span><br><span class="line"></span><br><span class="line">            setImmediate(() =&gt; console.log(&apos;[阶段3.immediate] 读文件回调3 增加的immediate 回调6&apos;))</span><br><span class="line"></span><br><span class="line">            setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 读文件回调3 增加的定时器回调8&apos;), 0);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    process.nextTick(() =&gt; &#123;</span><br><span class="line">        console.log(&apos;[...待切入下一阶段] 读文件回调 1 增加的 nextTick 回调6&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 定时器 回调5&apos;), 0)</span><br><span class="line">    setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 定时器 回调6&apos;), 0)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 定时器 回调1&apos;), 0)</span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">    console.log(&apos;[阶段1....定时器] 定时器 回调2&apos;)</span><br><span class="line"></span><br><span class="line">    process.nextTick(() =&gt; &#123;</span><br><span class="line">        console.log(&apos;[...待切入下一阶段] nextTick 回调5&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, 0)</span><br><span class="line">setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 定时器 回调3&apos;), 0)</span><br><span class="line">setTimeout(() =&gt; console.log(&apos;[阶段1....定时器] 定时器 回调4&apos;), 0)</span><br><span class="line"></span><br><span class="line">process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] nextTick 回调1&apos;))</span><br><span class="line">process.nextTick(() =&gt; &#123;</span><br><span class="line">    console.log(&apos;[...待切入下一阶段] nextTick 回调2&apos;)</span><br><span class="line">    process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] nextTick 回调4&apos;))</span><br><span class="line">&#125;)</span><br><span class="line">process.nextTick(() =&gt; console.log(&apos;[...待切入下一阶段] nextTick 回调3&apos;))</span><br><span class="line"></span><br><span class="line">$ node test/event-loop</span><br><span class="line">[...待切入下一阶段] nextTick 回调1</span><br><span class="line">[...待切入下一阶段] nextTick 回调2</span><br><span class="line">[...待切入下一阶段] nextTick 回调3</span><br><span class="line">[...待切入下一阶段] nextTick 回调4</span><br><span class="line">[...待切入下一阶段] promise 回调1</span><br><span class="line">[阶段1....定时器] 定时器 回调1</span><br><span class="line">[阶段1....定时器] 定时器 回调2</span><br><span class="line">[阶段1....定时器] 定时器 回调3</span><br><span class="line">[阶段1....定时器] 定时器 回调4</span><br><span class="line">[...待切入下一阶段] nextTick 回调5</span><br><span class="line">[阶段2....IO回调] 读文件回调1</span><br><span class="line">[...待切入下一阶段] 读文件回调 1 增加的 nextTick 回调6</span><br><span class="line">[阶段3.immediate] immediate 回调1</span><br><span class="line">[阶段3.immediate] immediate 回调2</span><br><span class="line">[阶段3.immediate] immediate 回调3</span><br><span class="line">[阶段3.immediate] promise 回调1 增加的immediate 回调4</span><br><span class="line">[阶段3.immediate] immediate 回调4</span><br><span class="line">[阶段3.immediate] immediate 回调6</span><br><span class="line">[...待切入下一阶段] 这块正在同步阻塞的读一个大文件</span><br><span class="line">[...待切入下一阶段] immediate 回调6 增加的 nextTick 回调7</span><br><span class="line">[...待切入下一阶段] immediate 回调6 增加的 nextTick 回调8</span><br><span class="line">[...待切入下一阶段] promise 回调2</span><br><span class="line">[...待切入下一阶段] promise 回调3</span><br><span class="line">[...待切入下一阶段] promise 回调2 增加的 nextTick 回调5</span><br><span class="line">[阶段1....定时器] 定时器 回调5</span><br><span class="line">[阶段1....定时器] 定时器 回调6</span><br><span class="line">[阶段2....IO回调] 读文件回调2</span><br><span class="line">[阶段2....IO回调] 读文件回调3</span><br><span class="line">[阶段3.immediate] 读文件回调2 增加的immediate 回调4</span><br><span class="line">[阶段3.immediate] 读文件回调3 增加的immediate 回调6</span><br><span class="line">[阶段1....定时器] 读文件回调3 增加的定时器回调8</span><br></pre></td></tr></table></figure>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-04-19T08:47:54.000Z" itemprop="dateUpdated">2018-04-19 16:47:54</time>
</span><br>


        
        本文地址：<a href="/node/event-loop/" target="_blank" rel="external">http://blog.master-ss.cn/node/event-loop/</a>
        
    </div>
    
    <footer>
        <a href="http://blog.master-ss.cn">
            <img src="/img/avatar.png" alt="张松松">
            张松松
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.master-ss.cn/node/event-loop/&title=《node 之 event-loop》 — 青松的博客&pic=http://blog.master-ss.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.master-ss.cn/node/event-loop/&title=《node 之 event-loop》 — 青松的博客&source=我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.master-ss.cn/node/event-loop/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《node 之 event-loop》 — 青松的博客&url=http://blog.master-ss.cn/node/event-loop/&via=http://blog.master-ss.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.master-ss.cn/node/event-loop/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/es6/decorator/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">es6 之 Decorator</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/es6/set&map/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">es6 之 Set &amp; Map</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "wUJ09egw1xIlxVQMQzLGKT4M-gzGzoHsz",
            appKey: "2Vk9VCblILWnai3FCQ0iQogY",
            avatar: "mm",
            placeholder: "写点什么？",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>张松松 &copy; 2016 - 2019</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">赣ICP备18001386号-1</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.master-ss.cn/node/event-loop/&title=《node 之 event-loop》 — 青松的博客&pic=http://blog.master-ss.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.master-ss.cn/node/event-loop/&title=《node 之 event-loop》 — 青松的博客&source=我们都知道 JavaScript 是单线程运行，异步操作特别重要。只要用到引擎之外的功能，就需要跟外部交互，从而形成异步操作。Node 的异步语法比浏览器..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.master-ss.cn/node/event-loop/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《node 之 event-loop》 — 青松的博客&url=http://blog.master-ss.cn/node/event-loop/&via=http://blog.master-ss.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.master-ss.cn/node/event-loop/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABxUlEQVR42u3aQY6DMAwF0N7/0ozU7Qj4jonL4mVVDS08ZmE53/l84nV819lf/n8+u3p9z8cWLi5um3tcrhx0/dv8nmffx8XFnedeF5rTH8d1Jil/UbHDxcV9GTdpd5JGp9UG4eLivox73b4kRS35d+Di4r6Hm29g8lKVRy1b9mq4uLgNbjUw3fF5Y76Li4tb5B7FlWxvkoZm8em4uLgj3DzmqBKT4GMtKMHFxd3NrQ5Hc0Sn27opYbi4uCPctSNT1YMU+cucljxcXNxx7tqoNR+ldI5xLM5ecHFxl7jVMUZe+KrDmDx8wcXFneRWb9F5ZPLNKMXBxcXdxu1sfjqPfGwmjIuLO85dK2rV7VNS+HBxcWe4TwUWz5YzXFzc93Cr25vqkYtkTHtTCnFxcUe4/WMW/V1J+TAHLi7uZm61PFVHqp1kAxcX97fcycRy7c64uLjz3Hwl7U6ezpZfDBcXd4S7b465tjXKr+Li4u7mdopXNVrNg5Kbc2S4uLgj3Lx45RFqZ4hbvoyLi/sjbicYTZ4S9WK4uLgv5uavVD2icWPDxcUd5K6NWqvHrarxSisWwcXFbXA7gel105NHq2vDGFxc3A3cP2I3dp10Y0luAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
