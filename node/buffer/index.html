<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>node 之 Buffer | 青松的博客 | 天行健，君子以自强不息；地势坤，君子以厚德载物。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有些开发者可能会形成思维定势，将 Buffer 当做字符串来理解。但字符串与 Buffer 之间有实质上的差异，即 Buffer 是二进制数据，字符串与 Buffer 之间存在编码关系。在 Node 中，应用需要处理网络协议、操作数据库、处理图片、">
<meta name="keywords" content="分享、总结">
<meta property="og:type" content="article">
<meta property="og:title" content="node 之 Buffer">
<meta property="og:url" content="http://blog.master-ss.cn/node/buffer/index.html">
<meta property="og:site_name" content="青松的博客">
<meta property="og:description" content="JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有些开发者可能会形成思维定势，将 Buffer 当做字符串来理解。但字符串与 Buffer 之间有实质上的差异，即 Buffer 是二进制数据，字符串与 Buffer 之间存在编码关系。在 Node 中，应用需要处理网络协议、操作数据库、处理图片、">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-01-24T03:05:51.391Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="node 之 Buffer">
<meta name="twitter:description" content="JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有些开发者可能会形成思维定势，将 Buffer 当做字符串来理解。但字符串与 Buffer 之间有实质上的差异，即 Buffer 是二进制数据，字符串与 Buffer 之间存在编码关系。在 Node 中，应用需要处理网络协议、操作数据库、处理图片、">
    
        <link rel="alternate" type="application/atom+xml" title="青松的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.png)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">张松松</h5>
          <a href="mailto:1733458402@qq.com" title="1733458402@qq.com" class="mail">1733458402@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/node">
                <i class="icon icon-lg icon-bandcamp"></i>
                Node
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/vuex">
                <i class="icon icon-lg icon-vimeo"></i>
                Vuex
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/zepto">
                <i class="icon icon-lg icon-anchor"></i>
                Zepto
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zss007" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://resume.master-ss.cn">
                <i class="icon icon-lg icon-link"></i>
                简历
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">node 之 Buffer</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">node 之 Buffer</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-01-24T01:13:59.353Z" itemprop="datePublished" class="page-time">
  2019-01-24
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/node/">node</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一、结构"><span class="post-toc-text">一、结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-1、模块结构"><span class="post-toc-text">1.1、模块结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2、Buffer-对象"><span class="post-toc-text">1.2、Buffer 对象</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#二、Buffer-的转换"><span class="post-toc-text">二、Buffer 的转换</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1、字符串转-Buffer"><span class="post-toc-text">2.1、字符串转 Buffer</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2、Buffer-转字符串"><span class="post-toc-text">2.2、Buffer 转字符串</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#三、Buffer-的拼接"><span class="post-toc-text">三、Buffer 的拼接</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-1、乱码产生原因"><span class="post-toc-text">3.1、乱码产生原因</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2、setEncoding"><span class="post-toc-text">3.2、setEncoding()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-3、正确拼接-Buffer"><span class="post-toc-text">3.3、正确拼接 Buffer</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-node/buffer" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">node 之 Buffer</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-01-24 09:13:59" datetime="2019-01-24T01:13:59.353Z" itemprop="datePublished">2019-01-24</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/node/">node</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有些开发者可能会形成思维定势，将 Buffer 当做字符串来理解。但字符串与 Buffer 之间有实质上的差异，即 Buffer 是二进制数据，字符串与 Buffer 之间存在编码关系。<br>在 Node 中，应用需要处理网络协议、操作数据库、处理图片、接收上传文件等，在网络流和文件的操作，还要处理大量二进制数据，JavaScript 自有的字符串远远不能满足这些需求，于是 Buffer 对象应运而生。<br><a id="more"></a> </p>
<h3 id="一、结构"><a href="#一、结构" class="headerlink" title="一、结构"></a>一、结构</h3><h4 id="1-1、模块结构"><a href="#1-1、模块结构" class="headerlink" title="1.1、模块结构"></a>1.1、模块结构</h4><p>Buffer 是一个像 Array 的对象，但它主要用于操作字节。</p>
<h4 id="1-2、Buffer-对象"><a href="#1-2、Buffer-对象" class="headerlink" title="1.2、Buffer 对象"></a>1.2、Buffer 对象</h4><p>Buffer 是一个典型的 JavaScript 与 C++ 结合的模块，它将性能相关部分用 C++ 实现，将非性能相关的部分用 JavaScript 实现。Buffer 所占用的内存不是通过 V8 分配的，属于堆外内存。由于 Buffer 太过常见，Node 在进程启动时就已经加载了它，并将其放在全局对象上。所以在使用 Buffer 时，无须通过 require() 即可直接使用。<br>Buffer 对象类似于数组，它的元素为 16 进制的两位数，即 0 到 255 的数值，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var str = &apos;深入浅出node.js&apos;</span><br><span class="line">var buff = new Buffer(str, &apos;utf-8&apos;)</span><br><span class="line"></span><br><span class="line">// &lt;Buffer e6 b7 b1 e5 85 a5 e6 b5 85 e5 87 ba 6e 6f 64 65 2e 6a 73&gt;</span><br><span class="line">console.log(buff)</span><br></pre></td></tr></table></figure></p>
<p>由上可见，不同编码的字符串占用的元素个数各不相同，上面代码中的中文字在 UTF-8 编码下占用 3 个元素，字母和半角标点符号占用 1 个元素。Buffer 受 Array 类型的影响很大，可以访问 length 属性得到长度，也可以通过下标访问元素，在构造对象时也十分相似：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var buff = new Buffer(100)</span><br><span class="line">// 100</span><br><span class="line">console.log(buff.length)</span><br></pre></td></tr></table></figure></p>
<p>可以通过下标对 Buffer 进行赋值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buff[10] = 100</span><br><span class="line">// 100</span><br><span class="line">console.log(buff[10])</span><br></pre></td></tr></table></figure></p>
<p>如果给元素赋值不是 0-255 而是小数时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buff[20] = -100</span><br><span class="line">// 156</span><br><span class="line">console.log(buff[20])</span><br><span class="line">buff[21] = 300</span><br><span class="line">// 44</span><br><span class="line">console.log(buff[21])</span><br><span class="line">buff[22] = 3.1415</span><br><span class="line">// 3</span><br><span class="line">console.log(buff[22])</span><br></pre></td></tr></table></figure></p>
<p>给元素的赋值如果小于 0，就将该值逐次加 256，直到得到一个 0 到 255 之间的整数。如果得到的数值大于 255，将逐次减 256，直到 0-255 区间内的数值。如果是小数，舍弃小数部分，只保留整数部分。</p>
<h3 id="二、Buffer-的转换"><a href="#二、Buffer-的转换" class="headerlink" title="二、Buffer 的转换"></a>二、Buffer 的转换</h3><p>Buffer 对象可以与字符串之间相互转换。</p>
<h4 id="2-1、字符串转-Buffer"><a href="#2-1、字符串转-Buffer" class="headerlink" title="2.1、字符串转 Buffer"></a>2.1、字符串转 Buffer</h4><p>字符串转 Buffer 对象主要是通过构造函数完成的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Buffer(str, [encoding])</span><br></pre></td></tr></table></figure></p>
<p>通过构造函数转换的 Buffer 对象，存储的只能是一种编码类型。encoding 参数不传递时，默认按 UTF-8 编码进行转码和存储。一个 Buffer 对象可以存储不同编码类型的字符串转码的值，调用 write() 方法可以实现该目的，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buff.write(string, [offset], [length], [encoding])</span><br></pre></td></tr></table></figure></p>
<p>由于可以不断写入内容到 Buffer 对象中，并且每次写入可以指定编码，所以 Buffer 对象中可以存在多种编码转化后的内容。需要小心的是，每种编码所用的字节长度不同，将 Buffer 反转回字符串时需要谨慎处理。</p>
<h4 id="2-2、Buffer-转字符串"><a href="#2-2、Buffer-转字符串" class="headerlink" title="2.2、Buffer 转字符串"></a>2.2、Buffer 转字符串</h4><p>实现 Buffer 向字符串的转换也十分简单，Buffer 对象的 toString() 可以将 Buffer 对象转换为字符串，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buff.toString([encoding], [start], [end])</span><br></pre></td></tr></table></figure></p>
<p>比较精巧的是，可以设置 encoding（默认为 UTF-8）、start、end 这 3 个参数实现整体或局部的转换。如果 Buffer 对象由多种编码写入，就需要在局部指定不同的编码，才能转换回正常的编码。</p>
<h3 id="三、Buffer-的拼接"><a href="#三、Buffer-的拼接" class="headerlink" title="三、Buffer 的拼接"></a>三、Buffer 的拼接</h3><p>Buffer 在使用场景中，通常是以一段一段的方式传输，以下是常见的从输入流中读取内容的示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;)</span><br><span class="line"></span><br><span class="line">var rs = fs.createReadStream(&apos;test.md&apos;)</span><br><span class="line">var data = &apos;&apos;</span><br><span class="line">rs.on(&apos;data&apos;, function (chunk) &#123;</span><br><span class="line">    data += chunk</span><br><span class="line">&#125;)</span><br><span class="line">rs.on(&apos;end&apos;, function (chunk) &#123;</span><br><span class="line">    console.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>上面这段代码常见于国外，用于流读取的示范，data 事件中获取的 chunk 对象即是 Buffer 对象。一旦输入流中有多字节编码时，问题就会暴露出来。这里潜在的问题在于如下这句代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data += chunk</span><br></pre></td></tr></table></figure></p>
<p>这句代码里隐藏了 toString() 操作，它等价于如下的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data += data.toString() + chunk.toString()</span><br></pre></td></tr></table></figure></p>
<p>值得注意的是，外国人语境通常是指英文环境，在他们的场景下，这个 toString() 不会造成任何问题。但对于多字节的中文，却会形成问题。为了重现这个问题，下面模拟近似的场景，将文件可读流的每次读取 Buffer 长度限制为 11，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var rs = fs.createReadStream(&apos;test.md&apos;, &#123;highWaterMark: 11&#125;)</span><br></pre></td></tr></table></figure></p>
<p>搭配该代码的测试数据为李白的《静夜思》。执行该程序，将会得到以下输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">窗前明��光，疑���地上霜。举头��明月，���头思故乡</span><br></pre></td></tr></table></figure></p>
<h4 id="3-1、乱码产生原因"><a href="#3-1、乱码产生原因" class="headerlink" title="3.1、乱码产生原因"></a>3.1、乱码产生原因</h4><p>上面的诗歌中，“月”、“是”、“望”、“低” 4个字没有被正常输出，取而代之的是�，产生这个输出结果的原因在于文件可读流在读取时会逐个读取 Buffer。这首歌原始 Buffer 应存储为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Buffer e5 ba 8a e5 89 8d e6 98 8e e6 9c 88 e5 85 89 ef bc 8c e7 96 91 e6 98 af e5 9c b0 e4 b8 8a e9 9c 9c ef bc 9b e4 b8 be e5 a4 b4 e6 9c 9b e6 98 8e e6 9c 88...&gt;</span><br></pre></td></tr></table></figure></p>
<p>由于限定了 Buffer 对象的长度为 11，因此只读流需要读取 7 次才能完成完成的读取，结果是以下几个 Buffer 对象依次输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Buffer e5 ba 8a e5 89 8d e6 98 8e e6 9c&gt;</span><br><span class="line">&lt;Buffer 88 e5 85 89 ef bc 8c e7 96 91 e6&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>上文提到 buff.toString() 方法默认以 UTF-8 为编码，中文字在 UTF-8 下占 3 个字节。所以第一个 Buffer 对象在输出时，只能显示 3 个字符，Buffer 中剩下的 2 个字节（e6 9c）将会以乱码的形式显示。第二个 Buffer 对象的第一个字节也不能形成文字，只能显示乱码，于是形成一些文字无法正常显示的问题。<br>在这个示例中，我们构造了 11 这个限制，但是对于任意长度的 Buffer 而言，多字节字符都有可能存在被截断的情况，只不过 Buffer 的长度越大出现的概率越低而已，但该问题依然不可忽视。</p>
<h4 id="3-2、setEncoding"><a href="#3-2、setEncoding" class="headerlink" title="3.2、setEncoding()"></a>3.2、setEncoding()</h4><p>在看过上述的示例后，也许我们忘记了可读流还有一个设置编码的方法 setEncoding()，示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readable.setEncoding(encoding)</span><br></pre></td></tr></table></figure></p>
<p>改方法的作用是让 data 事件中传递不再是一个 Buffer 对象，而是编码后的字符串。为此，我们继续改进前面的诗歌的程序，添加 setEncoding() 的步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var rs = fs.createReadStream(&apos;test.md&apos;, &#123; highWaterMark: 11 &#125;)</span><br><span class="line">rs.setEncoding(&apos;utf8&apos;)</span><br></pre></td></tr></table></figure></p>
<p>重新执行程序，得到输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">窗前明月光，疑是地上霜。举头望明月，低头思故乡</span><br></pre></td></tr></table></figure></p>
<p>那 Node 是如何实现这个输出结果的呢？要知道，无论如何设置编码，触发 data 事件的次数依旧相同，这意味着设置编码并未改变按段读取的基本方式。<br>事实上，在用 setEncoding() 时，可读流对象在内部设置了一个 decoder，它来自于 string_decoder 模块 StringDecoder 的实例对象。下面以代码来说明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var StringDecoder = require(&apos;string_decoder&apos;).StringDecoder</span><br><span class="line">var decoder = new StringDecoder(&apos;utf8&apos;)</span><br><span class="line"></span><br><span class="line">var buf1 = new Buffer([0xE5, 0xBA, 0x8A, 0xE5, 0x89, 0x8D, 0xE6, 0x98, 0x8E, 0xE6, 0x9C])</span><br><span class="line">console.log(decoder.write(buf1))</span><br><span class="line">// =&gt; 床前月</span><br><span class="line"></span><br><span class="line">var buf2 = new Buffer([0x88, 0xE5, 0x85, 0x89, 0xEF, 0xBC, 0x8C, 0xE7, 0x96, 0x91, 0xE6])</span><br><span class="line">console.log(decoder.write(buf2))</span><br><span class="line">// =&gt; 月光，疑</span><br></pre></td></tr></table></figure></p>
<p>StringDecoder 在得到编码后，知道多字节字符在 UTF-8 编码下以 3 个字节的方式存储，所以第一次 write() 时，只输出前 9 个字节转码形成的字符，“月”字的前两个字节被保留在 StringDecoder 实例内部，第二次 write() 时，会将 2 个剩余字节和后续 11 个字节组合在一起，再次用 3 的整数倍字节进行转码。于是乱码问题通过这种中间形式被解决了。<br>虽然 string_decoder 模块很奇妙，但是它只能处理几种编码，如 UTF-8、Base64、UCS-2/UTF-16LE。所以通过 setEncoding() 可以解决大部分的乱码问题，但并不能从根本上解决问题。</p>
<h4 id="3-3、正确拼接-Buffer"><a href="#3-3、正确拼接-Buffer" class="headerlink" title="3.3、正确拼接 Buffer"></a>3.3、正确拼接 Buffer</h4><p>淘汰掉 setEncoding() 方法后，剩下的解决方案只有将多个小 Buffer 对象拼接为一个 Buffer 对象，然后通过 iconv-lite 一类的模块来转码这种方式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var chunks = []</span><br><span class="line">var size = 0</span><br><span class="line">res.on(&apos;data&apos;, function (chunk) &#123;</span><br><span class="line">  chunks.push(chunk)</span><br><span class="line">  size += chunk.length</span><br><span class="line">&#125;)</span><br><span class="line">res.on(&apos;end&apos;, function () &#123;</span><br><span class="line">  var buf = Buffer.concat(chunks, size)</span><br><span class="line">  var str = iconv.decode(buf, &apos;utf8&apos;)</span><br><span class="line">  console.log(str)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>正确的拼接方式是用一个数组来存储接收到的所有 Buffer 片段，并记录下总长度，然后调用 Buffer.concat() 方法来生成一个合并的 Buffer 对象。Buffer.concat() 方法封装了从小 Buffer 对象向大 Buffer 对象的复制过程，实现十分细腻，值得学习：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Buffer.concat = function(list, length) &#123;</span><br><span class="line">  if (!Array.isArray(list)) &#123;</span><br><span class="line">    throw new Error(&apos;Usage: Buffer.concat(list, [length])&apos;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (list.length === 0) &#123;</span><br><span class="line">    return new Buffer(0);</span><br><span class="line">  &#125; else if (list.length === 1) &#123;</span><br><span class="line">    return list[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof length !== &apos;number&apos;) &#123;</span><br><span class="line">    length = 0;</span><br><span class="line">    for (var i = 0; i &lt; list.length; i++) &#123;</span><br><span class="line">      var buf = list[i];</span><br><span class="line">      length += buf.length; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var buffer = new Buffer(length);</span><br><span class="line">  varpos = 0;</span><br><span class="line">  for (var i = 0; i &lt; list.length; i++) &#123;</span><br><span class="line">    var buf = list[i];</span><br><span class="line">    buf.copy(buffer, pos);</span><br><span class="line">    pos += buf.length;</span><br><span class="line">  &#125;</span><br><span class="line">  return buffer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-01-24T03:05:51.391Z" itemprop="dateUpdated">2019-01-24 11:05:51</time>
</span><br>


        
        本文地址：<a href="/node/buffer/" target="_blank" rel="external">http://blog.master-ss.cn/node/buffer/</a>
        
    </div>
    
    <footer>
        <a href="http://blog.master-ss.cn">
            <img src="/img/avatar.png" alt="张松松">
            张松松
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.master-ss.cn/node/buffer/&title=《node 之 Buffer》 — 青松的博客&pic=http://blog.master-ss.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.master-ss.cn/node/buffer/&title=《node 之 Buffer》 — 青松的博客&source=JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.master-ss.cn/node/buffer/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《node 之 Buffer》 — 青松的博客&url=http://blog.master-ss.cn/node/buffer/&via=http://blog.master-ss.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.master-ss.cn/node/buffer/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/node/io/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">node 之异步 I/O</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/essay/https/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">网络之 https 协议</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "wUJ09egw1xIlxVQMQzLGKT4M-gzGzoHsz",
            appKey: "2Vk9VCblILWnai3FCQ0iQogY",
            avatar: "mm",
            placeholder: "写点什么？",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>张松松 &copy; 2016 - 2019</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">赣ICP备18001386号-1</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.master-ss.cn/node/buffer/&title=《node 之 Buffer》 — 青松的博客&pic=http://blog.master-ss.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.master-ss.cn/node/buffer/&title=《node 之 Buffer》 — 青松的博客&source=JavaScript 对于字符串的操作十分友好，无论是多字节字符还是单字节字符，都被认为是一个字符。在体验过 JavaScript 友好的字符串操作后，有..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.master-ss.cn/node/buffer/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《node 之 Buffer》 — 青松的博客&url=http://blog.master-ss.cn/node/buffer/&via=http://blog.master-ss.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.master-ss.cn/node/buffer/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwElEQVR42u3aO3LDMAwFQN//0kqbIqYeQBGJM8vKM5bJlQsM8Xm94nV9W/mT618luzUXLi7uNvdargSRg6r7/7AzLi7uIHd9WHXr5ODeC+Pi4v5NbvICyW64uLj/iZuEp3Vig4uL+yncPL1JjqkSj+RquLi4G9z8sHOfj9R3cXFxW9yruPLSZ7VsGp2Oi4s7ws0Dyn5JtBfIcHFx57lJEbPXMtm5bUUhDBcX9xj3RCBLCh/VssjBuIuLi/sm+Xl2lKoXIqOEChcXd4SbN0fXx1dDVTV9wsXFneT2wk3+7bOtGlxc3HnuU0NXvfCX/GW4uLjz3LwVmidLSZAq7ICLizvITVog+TP5xaXaqsHFxZ3h5peSamBaX4Pyq9LNM7i4uMe4+QG96kTv5W/myHBxcUe4O8nJOkbmF5eoyYqLizvILaQcrWHNh29huLi4x7hXcfWarDulFlxc3HludTwiL5WeeCVcXNxJbt7SqI5o7LRn3n6Li4s7yM2LpDtN1mryg4uL+ync3ghFL+l6Ve9TuLi4v8TNU5peQfZmT1xc3EFuEozyF8gHvMpFE1xc3BFuXjDtjWH1QuQD9V1cXNwO9wsxPWfWYcF4lAAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
